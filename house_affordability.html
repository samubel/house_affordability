<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Affordability Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        form { display: flex; flex-direction: column; }
        label { margin-top: 10px; }
        input { padding: 8px; margin-top: 5px; }
        button { margin-top: 20px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        .disclaimer { font-size: 12px; color: gray; }
    </style>
</head>
<body>
    <h1>House Affordability Calculator (MVP)</h1>
    <p>Enter details to see the max home price you can afford. Assumes 30-year conventional loan, 20% min down, no PMI.</p>
    <form id="calcForm">
        <label for="zip">Zip Code (e.g., 90210):</label>
        <input type="text" id="zip" required>
        
        <label for="credit">Credit Score (620-850):</label>
        <input type="number" id="credit" min="620" max="850" required>
        
        <label for="monthly">Desired Monthly Payment ($):</label>
        <input type="number" id="monthly" required>
        
        <label for="cash">Cash on Hand ($):</label>
        <input type="number" id="cash" required>
        
        <button type="submit">Calculate</button>
    </form>
    
    <div id="result"></div>
    
    <p class="disclaimer">This is an estimate, not financial advice. Assumes conventional loan. Data from APIs; rates as of now.</p>

    <script>
        const API_NINJAS_KEY = 'Q64xJleRtzhsgxOZy+28QA==Jk5rcHliO6ZD1W0m'; // Replace with your key
        const RENTCAST_KEY = '4230a50f24624ea1aab910a2cb613f2d'; // Replace with your key
        
        document.getElementById('calcForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const zip = document.getElementById('zip').value;
            const credit = parseInt(document.getElementById('credit').value);
            const monthly = parseFloat(document.getElementById('monthly').value);
            const cash = parseFloat(document.getElementById('cash').value);
            
            if (credit < 620) {
                document.getElementById('result').innerHTML = '<p>Error: Credit score too low for conventional loan.</p>';
                return;
            }
            
            try {
                // Fetch mortgage rate
                const rateRes = await fetch('https://api.api-ninjas.com/v1/mortgagerate', {
                    headers: { 'X-Api-Key': API_NINJAS_KEY }
                });
                const rateData = await rateRes.json();
                console.log('Mortgage rate data:', rateData); // Log for debugging
                if (!rateData || !rateData[0] || !rateData[0].frm_30) {
                    throw new Error('No valid mortgage rate data returned.');
                }
                let baseRate = rateData[0].frm_30;
                
                // Adjust rate by credit score
                let rateAdj = 0;
                if (credit >= 760) rateAdj = 0;
                else if (credit >= 700) rateAdj = 0.25;
                else if (credit >= 680) rateAdj = 0.5;
                else if (credit >= 660) rateAdj = 0.75;
                else if (credit >= 640) rateAdj = 1.25;
                else if (credit >= 620) rateAdj = 1.75;
                const adjRate = baseRate + rateAdj;
                
                // Fetch property tax rate
                const taxRes = await fetch(`https://api.api-ninjas.com/v1/propertytax?zip=${zip}`, {
                    headers: { 'X-Api-Key': API_NINJAS_KEY }
                });
                const taxData = await taxRes.json();
                console.log('Tax data:', taxData); // Log for debugging
                const taxRate = taxData[0] ? taxData[0].property_tax_50th_percentile : 0.011; // Default 1.1% if fail
                
                // Fetch avg home price suggestion (corrected endpoint and header)
                const avgPriceRes = await fetch(`https://api.rentcast.io/v1/markets?zip_codes=${zip}`, {
                    headers: { 'Authorization': `Bearer ${RENTCAST_KEY}` }
                });
                const avgPriceData = await avgPriceRes.json();
                console.log('Avg price data:', avgPriceData); // Log for debugging
                const avgHomePrice = avgPriceData && avgPriceData.length > 0 && avgPriceData[0].saleData ? avgPriceData[0].saleData.averagePrice : 'N/A';
                
                // Constants
                const loanTermYears = 30;
                const insuranceRateAnnual = 0.005; // 0.5%
                const hoaMonthly = 0;
                const closingCostPct = 0.03;
                
                // Monthly rates
                const rm = adjRate / 100 / 12;
                const n = loanTermYears * 12;
                const k = (taxRate + insuranceRateAnnual) / 12;
                const f = (1 - Math.pow(1 + rm, -n)) / rm;
                
                // Formula for max P
                const numerator = (monthly - hoaMonthly) * f + cash;
                const denominator = 1 + k * f + closingCostPct;
                let maxPrice = numerator / denominator;
                maxPrice = Math.floor(maxPrice / 100) * 100; // Round down to nearest 100
                
                // Check min 20% down
                const closingCosts = maxPrice * closingCostPct;
                const downPayment = cash - closingCosts;
                if (downPayment < maxPrice * 0.2 || isNaN(maxPrice) || maxPrice <= 0) {
                    document.getElementById('result').innerHTML = '<p>Insufficient cash for 20% down + closing costs or invalid calculation. Max affordable: $0</p>';
                    return;
                }
                
                // Output
                document.getElementById('result').innerHTML = `
                    <p><strong>Max Home Price You Can Afford:</strong> $${maxPrice.toLocaleString()}</p>
                    <p><strong>Suggested Avg Price in Zip ${zip}:</strong> $${typeof avgHomePrice === 'number' ? avgHomePrice.toLocaleString() : avgHomePrice}</p>
                    <p>Adjusted Interest Rate: ${adjRate.toFixed(2)}% | Tax Rate: ${(taxRate * 100).toFixed(2)}%</p>
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = '<p>Error fetching data. Check console or API keys.</p>';
                console.error('Error details:', error);
            }
        });
    </script>
</body>
</html>
